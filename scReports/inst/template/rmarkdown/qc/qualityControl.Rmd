---
title: "`r paste0(params$TA, ': ', params$project, ' ', params$experiment)`"
subtitle: "Quality Control (QC) Report ^[This document was automatically generated using the [R](http://www.r-project.org) statistical programming language and [(R)markdown](https://rmarkdown.rstudio.com/). The R code was developed by [Open Analytics](https://www.openanalytics.eu/).]"
author: "`r if (!is.null(params$analyst)) {paste0('Report generated by ', params$analyst, '<br>')}`"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: "journal"
params:
  pathToInputParams:
  analyst: NULL
  TA: "CS"
  project: "CS000001_Test"
  experiment: "CS000001_001_TestQC"
  workingDirectory: "./wdir/" 
  outputDirectory: "./wdir/"
  sampleIDs: 
    "sample1_h5"
  sampleNames:
   "sample1_h5" 
  metaFile: NULL
  # metaFile: "../../../../tests/testdata/meta/meta.tsv" 
  samplePaths: 
    "../../../../tests/testdata/sample1/raw_feature_bc_matrix.h5"
  sampleCRQC: 
   "../../../../tests/testdata/sample1/metrics_summary.csv"
  autoRotate: TRUE
  horizontalBarCharts: FALSE # only optional for nSamples less than or equal to 15
  horizontalViolinPlots: FALSE # only optional for nSamples less than or equal to 15
  saveRObjects: FALSE
  isFilteredData: FALSE
  debug: FALSE
  cellRangerCount: TRUE
---



```{css qc-css-style, echo = FALSE}

/* Whole document: */
body{
  font-family: Helvetica;
  text-align: justify;
  overflow: auto;
}

h1{
  text-align: left;
}

/* DT position buttons on the right */
.dataTables_wrapper .dt-buttons {
  float: right;  
}

/* DT vertical alignment of table column names */
.dt-top {
  vertical-align: top;
}
.dt-middle {
  vertical-align: middle;
}
.dt-bottom {
  vertical-align: bottom;
}

/* Correct the alignment of toc headers when they extend over more than one line */
.tocify-header {
  text-indent: initial;
}
.tocify-subheader > .tocify-item {
  text-indent: initial;
  padding-left: 2em;
}

```



```{r qc-libraries, echo = FALSE,  message = FALSE, warning = FALSE}

warnConflicts <- FALSE
library(ggplot2, warn.conflicts = warnConflicts)
library(formattable, warn.conflicts = warnConflicts)
library(DT, warn.conflicts = warnConflicts)
library(dplyr, warn.conflicts = warnConflicts)
library(RColorBrewer, warn.conflicts = warnConflicts)
library(plotly, warn.conflicts = warnConflicts)
library(scReports, warn.conflicts = warnConflicts)

```



```{r qc-global-options, echo = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(
  eval = TRUE,
  echo = FALSE, 
  message = FALSE,
  cache = FALSE,
  warning = FALSE,
  error = FALSE,
  comment = "#",
  tidy = FALSE,
  collapse = TRUE,
  results = "asis",
  fig.pos = "H",
  fig.align = "center",
  fig.width = 8.5,
  fig.height = 6.5
)

knitr::opts_knit$set(
  root.dir = params$workingDir
)

options(warn = -1) # 1 or -1

```



```{r qc-render-chunk-parameters, echo = FALSE, message = FALSE, warning = FALSE}

## Render chunk parameters (used during report development)
renderMetaTable <- TRUE
renderMetricContent <- TRUE
renderMetricBarCharts <- TRUE
readInRawData <- TRUE
runGeneExpression <- FALSE
runAntibody <- FALSE 
renderViolinGEX <- FALSE
renderViolinADT <- FALSE
renderScatterGEX <- FALSE
renderScatterGEXADT <- FALSE
renderKneePlots <- TRUE
renderHeatmaps <- TRUE
renderSampleDendrogram <- TRUE
renderAntibodyDendrogram <- TRUE

```



```{r qc-parameter-checks}

if (params$debug) {
  
  message("sampleIDs: ", params$sampleIDs, " class: ", class(params$sampleIDs))
  message("sampleNames: ", params$sampleNames, " class: ", class(params$sampleNames))
  message("samplePaths: ", params$samplePaths, " class: ", class(params$samplePaths))
  message("sampleCRQC: ", params$sampleCRQC, " class: ", class(params$sampleCRQC))
  message("metaFile: ", params$metaFile, " class: ", class(params$metaFile))
  
}

initialParameterChecks(sampleNames = params$sampleIDs, 
                       samplePaths = params$samplePaths, 
                       sampleCRQC = params$sampleCRQC,
                       metaFile = params$metaFile)

```



```{r qc-check-requirements}

# Meta data table
if (is.null(params$metaFile)) {
  
  renderMetaTable <- FALSE
  message("A meta data file was not specified. \n",
          "Skipping the meta data section...")
  
} else if (!file.exists(params$metaFile)) {
  
  renderMetaTable <- FALSE
  message("The meta data file does not exist. \n",
          "Skipping the meta data section...")
  
}

# Cell Ranger metrics

if (is.null(params$sampleCRQC)) {
  
  renderMetricContent <- FALSE
  message("Cell Ranger summary metric files weren't specified. \n",
          "Skipping the QC metrics section...")
  
} else if (any(!file.exists(params$sampleCRQC))) {
  
  renderMetricContent <- FALSE
  message("One or more of the summary metrics files do not exist. \n",
          "Skipping the QC metrics section...")
  
}

# Cell Ranger metrics bar charts
if (!is.null(params$sampleCRQC) & length(params$sampleCRQC) > 200) {
  
  renderMetricBarCharts <- FALSE
  message("Currently, bar charts of the Cell Ranger metrics are only created 
           if the number of samples is less than 200.")
  
}

# Raw data

if (is.null(params$samplePaths)) {
  
  readInRawData <- FALSE
  message("Sample paths weren't specified. \n",
          "Skipping the Raw data sections...")
  
} else if (any(!file.exists(params$samplePaths))) {
  
  readInRawData <- FALSE
  message("One or more of the sample paths do not exist. \n",
          "Skipping the Raw data sections...")
  
}


# Knee plots: require DropletUtils
if (!require(DropletUtils, quietly = TRUE)) {
  
  renderKneePlots <- FALSE
  message("\nThe suggested package DropletUtils is not available for rendering the knee plots. \n",
          "Install 'DropletUtils' if you would like knee plots included in the report.")
  
}

```



```{r qc-initialize-parameters, echo = FALSE, message = FALSE, warning = FALSE}

nSamples <- length(params$samplePaths)

if (!params$autoRotate & nSamples <= 30) {
  horizontalBarCharts <- params$horizontalBarCharts
  horizontalViolinPlots <- params$horizontalViolinPlots
} else {
  horizontalBarCharts <- nSamples > 30 
  horizontalViolinPlots <- nSamples > 30
}
horizontalKneePlotOverview <- nSamples > 30
saveRObjects <- params$saveRObjects

# Plotting parameters
standardFigWidth <- 8.5
standardFigHeight <- 6.5

```



```{r qc-meta-data, eval = renderMetaTable, child = getPathChild("qcMetaData.Rmd", report = "qc")}

```



```{r qc-cell-ranger-metrics, eval = renderMetricContent, child = getPathChild("qcCellRangerMetrics.Rmd", report = "qc")}

```



```{r qc-read-in-raw-data, eval = readInRawData}

# get dgCMatrices of counts
rawData <- readSingleCellData(
  sampleNames = params$sampleIDs, 
  samplePaths = params$samplePaths, 
  verbose = params$debug
)

if (params$debug) {
  
  message("rawData class: ", class(rawData))
  message("rawData names: ", 
          paste(names(rawData), collapse = ", "))
  for (i in names(rawData)) {
    
    message("rawData[[\"", i, "\"]] names: ", 
            paste(names(rawData[[i]]), collapse = ", "))
    message("rawData[[\"", i, "\"]] class: ", class(rawData[[i]]))
    
  }
  
}

# extract/compute primary QC metric columns
fileExtensions <- getFileExtensions(params$samplePaths)
if (all(fileExtensions == "h5ad") & params$isFilteredData) {
  
  metricData <- mapply(
    FUN = extractMetrics,
    sampleName = params$sampleNames,
    path = params$samplePaths,
    SIMPLIFY = FALSE
  )
  
} else {
  
  metricData <- mapply(
    FUN = computeMetrics,
    sampleName = names(rawData),
    X = rawData,
    verbose = params$debug,
    SIMPLIFY = FALSE
  )
  
}

# apply minimal filtering on raw data 

if (!params$isFilteredData) {
  
  filteredData <- mapply(
    FUN = filterSCData,
    X = rawData,
    qcMetrics = metricData,
    sampleName = names(rawData),
    applyMultiModalCellFiltering = TRUE,
    verbose = params$debug,
    SIMPLIFY = FALSE
  )
  
} else {
  
  filteredData <- mapply(
    FUN = function(rawData, metricData) {
      list("XFiltered" = rawData, "qcMetricsFiltered" = metricData)
    },
    rawData = rawData, 
    metricData = metricData, 
    SIMPLIFY = FALSE
  )
  
}


# only utilize cell-level metrics
cellMetricData <- lapply(
  X = filteredData,
  FUN = function(x) x$qcMetricsFiltered$cells
)

# combine the cell-level metrics for multiple samples
primaryQCData <- combineMetrics(
  X = cellMetricData,
  fillMissing = TRUE
)

if (all(primaryQCData$nCount_RNA == 0)) {
  
  pander::pandoc.p(
    cat("Note: nCount_RNA is zero for all cells.",
        "The remaining chapters will not be generated.")
  )
  
} else {
  
  # update the GEX logical arguments
  gexDataPresent <- unlist(
    lapply(
      X = rawData, 
      FUN = function(x) "RNA" %in% names(x)
    )
  )
  runGeneExpression <- any(gexDataPresent)
  
  if (runGeneExpression) {
    
    requiredCols <- c("sampleName", "nCount_RNA", "nFeature_RNA")  
    renderViolinGEX <- 
      renderScatterGEX <- all(requiredCols %in% colnames(primaryQCData))
    percentMitoPresent <- "percentMito" %in% colnames(primaryQCData)
    
  }
  
  # update the ADT logical arguments
  antibodyDataPresent <- unlist(
    lapply(
      X = rawData, 
      FUN = function(x) "ADT" %in% names(x)
    )
  )
  runAntibody <- any(antibodyDataPresent)
  renderHeatmaps <- runAntibody
  
  if (runAntibody) {
    
    requiredCols <- c("sampleName", "nCount_ADT", "nFeature_ADT")  
    renderViolinADT <- all(requiredCols %in% colnames(primaryQCData))
    
  }
  
  # update the GEX and ADT logical arguments
  if (runGeneExpression & runAntibody) {
    
    requiredCols <- c("nCount_RNA", "nCount_ADT")
    renderScatterGEXADT <- all(requiredCols %in% colnames(primaryQCData))
    
  }
  
  
}

```



```{r qc-gex, eval = readInRawData & runGeneExpression, child = getPathChild("qcGex.Rmd", report = "qc")}

```



```{r qc-adt, eval = readInRawData & runAntibody, child = getPathChild("qcAdt.Rmd", report = "qc")}

```



```{r qc-gexadt, eval = readInRawData & runGeneExpression & runAntibody, child = getPathChild("qcGexAndAdt.Rmd", report = "qc")}

```



```{r qc-save-rds, eval = readInRawData & saveRObjects}

saveRDS(qcTable, file = "qc.rds")
saveRDS(rawData, file = "rawData.rds")

```



```{r qc-clear-workspace-2, eval = readInRawData}

rm("rawData")

```



```{r qc-appendix, child = getPathChild("appendix.Rmd")}

```

